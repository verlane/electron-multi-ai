<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Multi AI Chat</title>
  <style>
    * {
      font-family: 'Meiryo UI';
    }

    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #191a1a;
    }

    .views {
      flex: 1;
      display: flex;
    }

    webview {
      flex: 1;
    }

    #input-container {
      padding: 10px;
      background: #191a1a;
    }

    #chat-input {
      display: block;
      margin: 0 auto;
      padding-left: 6px;
      width: 800px;
      height: 50px;
      background: #303030;
      color: #eee;
      font-size: 16px;
      resize: none;
    }

    #chat-input:focus {
      outline: none;
    }
  </style>
</head>

<body>
  <div class="views">
    <webview id="chatgpt" src="https://chatgpt.com/" partition="persist:chatgpt"></webview>
    <webview id="perplexity" src="https://www.perplexity.ai/" partition="persist:perplexity"></webview>
    <webview id="grok" src="https://grok.com/" partition="persist:grok"></webview>
  </div>
  <div id="input-container">
    <textarea id="chat-input" placeholder="메시지를 입력하고 Enter로 전송"></textarea>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const input = document.getElementById('chat-input');
    input.addEventListener('keydown', (e) => {
      if (!e.ctrlKey && !e.shiftKey && e.key === 'Enter') {
        const message = input.value.trim();
        if (message) {
          ipcRenderer.send('send-message', message);
          input.value = '';
        }
        e.preventDefault();
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('chat-input').focus();
      }, 3000);
    });

    ipcRenderer.on('focus-chat', () => {
      document.getElementById('chat-input').focus();
    });

    let sendingCount = 0;

    ipcRenderer.on('dispatch-message', (_, message, mainWindowBounds) => {
      // 창 너비와 최초 전송 여부에 따라 시나리오 키 결정
      const sizeKey = mainWindowBounds.width < 1600 ? 'small' : 'large';
      const sendKey = sendingCount < 1 ? 'first' : 'subsequent';

      // 각 시나리오별로 대상(webview)별 액션 목록 정의
      const scenarios = {
        small: {
          first: {
            chatgpt: [
              { type: 'click-relative', x: 324, y: 1925 },
              { type: 'clipboard-paste', text: message },
            ],
            perplexity: [
              { type: 'click-relative', x: 930, y: 320 },
              { type: 'clipboard-paste', text: message }
            ],
            grok: [
              { type: 'click-relative', x: 1604, y: 1937 },
              { type: 'clipboard-paste', text: message }
            ],
            etc: [
              { type: 'click-relative', x: 589, y: 1992 }
            ]
          },
          subsequent: {
            chatgpt: [
              { type: 'click-relative', x: 324, y: 1925 },
              { type: 'clipboard-paste', text: message },
            ],
            perplexity: [
              { type: 'click-relative', x: 932, y: 1939 },
              { type: 'clipboard-paste', text: message }
            ],
            grok: [
              { type: 'click-relative', x: 1604, y: 1937 },
              { type: 'clipboard-paste', text: message }
            ],
            etc: [
              { type: 'click-relative', x: 589, y: 1992 }
            ]
          }
        },
        large: {
          first: {
            chatgpt: [
              { type: 'click-relative', x: 660, y: 1050 },
              { type: 'clipboard-paste', text: message }
            ],
            perplexity: [
              { type: 'click-relative', x: 2040, y: 1010 },
              { type: 'clipboard-paste', text: message }
            ],
            grok: [
              { type: 'click-relative', x: 3100, y: 1080 },
              { type: 'clipboard-paste', text: message }
            ]
          },
          subsequent: {
            chatgpt: [
              { type: 'click-relative', x: 634, y: 1917 },
              { type: 'clipboard-paste', text: message }
            ],
            perplexity: [
              { type: 'click-relative', x: 1950, y: 2000 },
              { type: 'clipboard-paste', text: message }
            ],
            grok: [
              { type: 'click-relative', x: 3060, y: 1940 },
              { type: 'clipboard-paste', text: message }
            ]
          }
        }
      };

      // 선택된 시나리오에 해당하는 액션 목록을 순회하며 전송
      const actions = scenarios[sizeKey][sendKey];
      Object.values(actions).forEach(actionList => {
        actionList.forEach(action => {
          ipcRenderer.send('robot-action', action);
        });
      });

      sendingCount++;

      setTimeout(() => {
        document.getElementById('chat-input').focus();
      }, 5000);
    });
  </script>
</body>

</html>